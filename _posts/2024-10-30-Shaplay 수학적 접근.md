---
title: Shaplay 수학적 접근
date: 2024-11-05 16:00:00 +09:00
categories: [Project, 데이터 사이언스]
tags:
  [
    Project,
    WEB,
    DATA,
    데이터 사이언스,
    XAI,
    설명가능한 AI,
    .
    .
    .
  ]
---

SHAP(SHapley Additive exPlanations)는 협동 게임 이론에서 나오는 Shapley 값을 기반으로 합니다. 이 값은 모델 예측에서 각 피처(feature)가 얼마나 기여했는지를 계산하는 방법입니다.

Shapley 값의 수학적 원리를 한 단계씩 쉽게 풀어보겠습니다.

1. 협동 게임 이론이란?
Shapley 값은 원래 협동 게임 이론(cooperative game theory)에서 사용된 개념입니다. 여기서 게임은 여러 플레이어들이 협력하여 결과를 얻는 상황을 가정합니다. 게임의 목표는 각 플레이어가 결과에 얼마나 기여했는지를 공정하게 나누는 것입니다.

예시: 피자 나누기 게임
세 명이 피자를 먹는다고 가정해 볼게요. 각 사람이 피자 한 조각을 먹기 위해 얼마나 기여했는지 계산하고, 그에 따라 피자를 나누어주려고 합니다. 누군가가 피자를 더 많이 가져가면 안 되겠죠. 이 상황에서 Shapley 값은 각 사람이 협력한 전체 기여도를 공정하게 나누는 방법입니다.

2. Shapley 값의 수학적 정의
Shapley 값은 모든 가능한 순서에서의 기여를 계산한 평균입니다. 각 플레이어(피처)가 여러 사람들과 협력했을 때 게임의 결과에 얼마나 기여했는지를 계산하고, 그 결과를 평균하여 그 사람의 기여도를 구합니다.

Shapley 값 공식:
피처 
𝑖
i의 Shapley 값 
𝜙
𝑖
ϕ 
i
​
 는 다음과 같이 정의됩니다:

𝜙
𝑖
=
∑
𝑆
⊆
𝑁
∖
{
𝑖
}
∣
𝑆
∣
!
(
∣
𝑁
∣
−
∣
𝑆
∣
−
1
)
!
∣
𝑁
∣
!
(
𝑣
(
𝑆
∪
{
𝑖
}
)
−
𝑣
(
𝑆
)
)
ϕ 
i
​
 = 
S⊆N∖{i}
∑
​
  
∣N∣!
∣S∣!(∣N∣−∣S∣−1)!
​
 (v(S∪{i})−v(S))
여기서:

𝑁
N은 모든 피처들의 집합입니다.
𝑆
⊆
𝑁
∖
{
𝑖
}
S⊆N∖{i}는 피처 
𝑖
i를 제외한 피처들의 모든 부분 집합입니다.
∣
𝑆
∣
∣S∣는 집합 
𝑆
S의 크기, 즉 피처의 개수입니다.
𝑣
(
𝑆
)
v(S)는 피처 집합 
𝑆
S가 있을 때 모델이 내는 예측 값입니다.
𝑣
(
𝑆
∪
{
𝑖
}
)
v(S∪{i})는 
𝑆
S에 피처 
𝑖
i를 추가했을 때 모델의 예측 값입니다.
이 수식은 각 피처 
𝑖
i가 모든 다른 피처 집합과 협력했을 때 기여한 정도를 계산한 후, 그 기여도의 평균을 구하는 방식입니다.

3. 왜 모든 순서를 고려할까?
Shapley 값은 공정한 기여도를 계산하기 위해 모든 피처들이 어떤 순서로 모델에 들어왔는지를 고려합니다. 왜냐하면, 어떤 피처가 먼저 들어오느냐에 따라 기여도가 달라질 수 있기 때문입니다.

예시: 팀 프로젝트
네 명이 팀 프로젝트를 한다고 가정해볼게요. 어떤 사람은 자료 조사를 잘하고, 다른 사람은 발표를 잘합니다. 하지만, 프로젝트에서 누가 먼저 어떤 일을 했는지에 따라 전체 기여도가 다르게 보일 수 있습니다. Shapley 값은 모든 사람이 모든 순서에서 프로젝트에 기여한 정도를 고려하고, 그 평균을 구해서 가장 공정한 분배를 하려는 것입니다.

4. Shapley 값 계산의 직관적 설명
모델 예측에서 Shapley 값을 계산하는 과정은 다음과 같이 요약할 수 있습니다:

피처들이 없는 상태에서 모델이 내는 예측 값(기준값)을 구합니다.
각 피처를 하나씩 추가했을 때 예측 값이 얼마나 변했는지 봅니다.
이 변화를 피처의 기여도로 간주하고, 모든 가능성에 대해 반복해서 계산한 후, 그 평균을 구합니다.
예시: 예측 모델에서 Shapley 값
온도, 습도, 공기질 데이터를 사용하는 예측 모델이 있다고 해볼게요. 이 모델이 창문을 열지 닫을지 결정한다고 할 때, 각 피처(온도, 습도, 공기질)가 예측에 얼마나 기여했는지를 알고 싶습니다.

Shapley 값은 먼저 모든 피처를 하나씩 추가해보면서 예측 결과가 어떻게 변하는지 봅니다.
그 변화를 통해 각 피처가 얼마나 중요한 역할을 했는지를 계산합니다.
여러 순서로 피처를 추가해보고 그 결과를 평균 내서 공정한 기여도를 구하는 것이 바로 Shapley 값입니다.
5. Shapley 값의 장점
공정함: Shapley 값은 모든 피처에 대해 공평한 기여도를 계산합니다. 이는 어떤 피처도 부당하게 과소평가되거나 과대평가되지 않게 해줍니다.
모델 독립적: Shapley 값은 어떤 종류의 모델이든 적용할 수 있습니다. 선형 모델, 트리 기반 모델, 신경망 등 다양한 모델에서 사용 가능합니다.
설명력: 블랙박스 모델의 예측을 쉽게 해석할 수 있게 해줍니다.
이제 Shapley 값이 게임에서 누가 기여를 더 했는지 공정하게 나누는 방식에서 나온 개념임을 이해하셨을 거에요. 머신러닝 모델에서는 피처들이 예측에 얼마나 기여했는지를 계산하는 방법으로 쓰입니다.
